(()=>{var t={n:o=>{var e=o&&o.__esModule?()=>o.default:()=>o;return t.d(e,{a:e}),e},d:(o,e)=>{for(var n in e)t.o(e,n)&&!t.o(o,n)&&Object.defineProperty(o,n,{enumerable:!0,get:e[n]})},o:(t,o)=>Object.prototype.hasOwnProperty.call(t,o),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},o={};(()=>{"use strict";t.r(o),t.d(o,{components:()=>R,extend:()=>Q,utils:()=>X});const e=flarum.reg.get("core","forum/app");var n=t.n(e);const r=flarum.reg.get("core","common/extend");function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function a(t,o,e){return(o=function(t){var o=function(t){if("object"!=i(t)||!t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var e=o.call(t,"string");if("object"!=i(e))return e;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==i(o)?o:o+""}(o))in t?Object.defineProperty(t,o,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[o]=e,t}const s=flarum.reg.get("core","common/Component");var c=t.n(s);const u=flarum.reg.get("core","common/components/FieldSet");var l=t.n(u);const d=flarum.reg.get("core","common/helpers/listItems");var f=t.n(d);const g=flarum.reg.get("core","common/utils/ItemList");var h=t.n(g);const p=flarum.reg.get("core","common/components/LoadingIndicator");var b=t.n(p);const v=flarum.reg.get("core","common/components/Button");var k=t.n(v);const L=flarum.reg.get("core","common/components/Link");var y=t.n(L);const I=flarum.reg.get("core","common/helpers/humanTime");var w=t.n(I);class _ extends(c()){oncreate(t){super.oncreate(t)}view(t){const{provider:o}=this.attrs;return o.orphaned()?m("div",null,m("p",{className:"LinkedAccountsList-item-title"},o.name()),m("p",{className:"helpText"},n().translator.trans("fof-oauth.forum.user.settings.linked-account.orphaned-account")),m("div",{className:"LinkedAccountsList-item-data"},this.providerInfoItems(o).toArray())):o.linked()?m("div",null,m("p",{className:"LinkedAccountsList-item-title"},n().translator.trans("fof-oauth.forum.providers.".concat(o.name()))),m("div",{className:"LinkedAccountsList-item-data"},this.providerInfoItems(o).toArray())):m("div",null,m("p",{className:"LinkedAccountsList-item-title"},n().translator.trans("fof-oauth.forum.providers.".concat(o.name()))))}providerInfoItems(t){const o=flarum.reg.get("core","common/components/LabelValue"),e=new(h());return e.add("firstLogin",m(o,{label:n().translator.trans("fof-oauth.forum.user.settings.linked-account.link-created-label"),value:w()(t.firstLogin())}),100),e.add("lastLogin",m(o,{label:n().translator.trans("fof-oauth.forum.user.settings.linked-account.last-used-label"),value:w()(t.lastLogin())}),90),e.add("identification",m(o,{label:n().translator.trans("fof-oauth.forum.user.settings.linked-account.identification-label",{provider:n().translator.trans("fof-oauth.forum.providers.".concat(t.name()))}),value:t.identifier()}),80),e}}flarum.reg.add("lstechneighbor-tcp-oidc","forum/components/ProviderInfo",_);const P=flarum.reg.get("core","common/utils/extractText");var A=t.n(P);const x=flarum.reg.get("core","common/components/Icon");var S=t.n(x);class N extends(c()){constructor(){super(...arguments),a(this,"state",{loading:!1})}onbeforeupdate(t){super.onbeforeupdate(t),n().fof_oauth_linkingInProgress&&n().fof_oauth_linkingProvider===this.attrs.provider.name()?this.state.loading=!0:!1===n().fof_oauth_linkingInProgress&&n().fof_oauth_linkingProvider===this.attrs.provider.name()&&(this.state.loading=!1,delete n().fof_oauth_linkingInProgress,delete n().fof_oauth_linkingProvider)}view(t){return m("div",{className:"LinkedAccountsList-item LinkedAccountsList-item--".concat(this.attrs.provider.name())},this.iconView(),this.statusView(),this.actionView())}iconView(){return m("div",{className:"LinkedAccountsList-item-icon"},m(S(),{name:this.attrs.provider.icon(),className:"Provider-Icon Provider-Icon--".concat(this.attrs.provider.name())}))}statusView(){const t=this.attrs.provider;return m(_,{provider:t})}actionView(){var t;const o=this.attrs.provider,e=this.attrs.user;return o.linked()?m("div",{className:"LinkedAccountsList-item-actions"},m(k(),{className:"Button FoFLogInButton LogInButton--".concat(o.name()," LogInButton").concat(o.linked()?"--linked":"--unlinked"),icon:o.icon(),onclick:()=>this.deleteProvider(o),loading:this.state.loading},n().translator.trans("fof-oauth.forum.unlink"))):o.orphaned()||e.id()!==(null==(t=n().session.user)?void 0:t.id())&&n().forum.attribute("fofOauthModerate")?null:m("div",{className:"LinkedAccountsList-item-actions"},m(y(),{className:"Button FoFLogInButton LogInButton--".concat(o.name()),icon:o.icon(),href:"".concat(n().forum.attribute("baseUrl"),"/auth/").concat(o.name(),"?linkTo=").concat(e.id()),loading:this.state.loading,external:!0},n().translator.trans("fof-oauth.forum.log_in.with_".concat(o.name(),"_button"),{provider:n().translator.trans("fof-oauth.forum.providers.".concat(o.name()))})))}async deleteProvider(t){confirm(A()(n().translator.trans("fof-oauth.forum.user.settings.linked-account.unlink-confirm",{provider:n().translator.trans("fof-oauth.forum.providers.".concat(t.name()))})))&&(this.state.loading=!0,await t.delete(),await n().store.find("users/"+this.attrs.user.id()+"/linked-accounts",{}),this.state.loading=!1,m.redraw())}}flarum.reg.add("lstechneighbor-tcp-oidc","forum/components/LinkStatus",N);class B extends(c()){constructor(){super(...arguments),a(this,"state",{loadingAdditional:!0,errorLoadingAdditional:!1})}oncreate(t){super.oncreate(t),this.loadLinkedAccounts()}view(t){const o=n().store.all("linked-accounts");return m(l(),{label:n().translator.trans("fof-oauth.forum.user.settings.linked-account.label")},m("p",{className:"helpText"},n().translator.trans("fof-oauth.forum.user.settings.linked-account.help")),this.state.loadingAdditional?m(b(),{containerClassName:"LinkedAccounts-Loading"}):m("ul",{className:"LinkedAccountsList"},f()(this.linkedAccountsItems(o,this.attrs.user).toArray())))}linkedAccountsItems(t,o){const e=new(h());return t.forEach((t=>{e.add(t.name(),m(N,{provider:t,user:o}),t.priority())})),e}async loadLinkedAccounts(){await n().store.find("linked-accounts",{filter:{userId:this.attrs.user.id()}}),this.state.loadingAdditional=!1,m.redraw()}}function O(){(0,r.extend)("flarum/forum/components/UserSecurityPage","settingsItems",(function(t){var o,e;((null==(o=this.user)?void 0:o.id())===(null==(e=n().session.user)?void 0:e.id())||n().forum.attribute("fofOauthModerate"))&&t.add("linkedAccounts",m(B,{user:this.user}),5)}))}flarum.reg.add("lstechneighbor-tcp-oidc","forum/components/LinkedAccounts",B),flarum.reg.add("lstechneighbor-tcp-oidc","forum/extenders/addLinkedAccountsToUserSecurityPage",O);const F=flarum.reg.get("core","forum/components/LogInButtons");var M=t.n(F);const T=flarum.reg.get("core","forum/components/LogInButton");var U=t.n(T);const V=flarum.reg.get("core","common/components/Tooltip");var j=t.n(V);function C(t,o){if(t.forum.attribute("fof-oauth.fullscreenPopup"))window.open(t.forum.attribute("baseUrl")+o.path,"logInPopup","fullscreen=yes");else{var e,n;const r=580,i=400,a=t.forum.attribute("fof-oauth.popupWidth")||r,s=t.forum.attribute("fof-oauth.popupHeight")||i,c=(null!=(e=$(window).height())?e:0)/2-s/2,u=(null!=(n=$(window).width())?n:0)/2-a/2;window.open(t.forum.attribute("baseUrl")+o.path,"logInPopup","width=".concat(a,",")+"height=".concat(s,",")+"top=".concat(c,",")+"left=".concat(u,",")+"status=no,scrollbars=yes,resizable=no")}}flarum.reg.add("lstechneighbor-tcp-oidc","forum/utils/popupUtils",{openOAuthPopup:C});const E=flarum.reg.get("core","common/extenders");var G=t.n(E);const q=flarum.reg.get("core","common/models/User");var z=t.n(q);const D=flarum.reg.get("core","common/Model");var K=t.n(D);class H extends(K()){name(){return K().attribute("name").call(this)}icon(){return K().attribute("icon").call(this)}priority(){return K().attribute("priority").call(this)}linked(){return K().attribute("linked").call(this)}orphaned(){return K().attribute("orphaned").call(this)}identifier(){return K().attribute("identifier").call(this)}firstLogin(){return K().attribute("firstLogin",K().transformDate).call(this)}lastLogin(){return K().attribute("lastLogin",K().transformDate).call(this)}userId(){return K().attribute("userId").call(this)}}flarum.reg.add("lstechneighbor-tcp-oidc","forum/models/LinkedAccount",H);const W=flarum.reg.get("core","common/query/IGambit");class J extends W.KeyValueGambit{key(){return n().translator.trans("fof-oauth.lib.gambits.sso.key",{},!0)}hint(){return n().translator.trans("fof-oauth.lib.gambits.sso.hint",{},!0)}filterKey(){return"sso"}enabled(){return!!n().forum.attribute("fofOauthModerate")}}flarum.reg.add("lstechneighbor-tcp-oidc","forum/query/SsoGambit",J);const Q=[new(G().Model)(z()).attribute("loginProvider"),(new(G().Store)).add("linked-accounts",H),(new(G().Search)).gambit("users",J)],R={ProviderInfo:_,LinkStatus:N,LinkedAccounts:B};flarum.reg.add("lstechneighbor-tcp-oidc","forum/components",null);const X={openOAuthPopup:C};flarum.reg.add("lstechneighbor-tcp-oidc","forum/utils",null),n().initializers.add("lstechneighbor-tcp-oidc",(()=>{(0,r.extend)(U(),"initAttrs",(function(t,o){o.onclick=function(){C(n(),o)}})),(0,r.extend)(M().prototype,"items",(function(t){const o=!!n().forum.attribute("lstechneighbor-tcp-oidc.only_icons");let e=n().forum.attribute("lstechneighbor-tcp-oidc")||[];var r,i;if(e&&0!==e.length||(e=(null==(r=n().forum.data)||null==(r=r.attributes)?void 0:r["lstechneighbor-tcp-oidc"])||[]),e&&0!==e.length||(e=(null==(i=n().forum.payload)?void 0:i["lstechneighbor-tcp-oidc"])||[]),!e||0===e.length)return;const a=e.filter(Boolean),s=a.splice(a.indexOf(a.find((t=>"google"===t.name))),1);a.concat(s).forEach((e=>{let{name:r,icon:i,priority:a}=e,s="Button FoFLogInButton LogInButton--".concat(r);o&&"google"!==r&&(s+=" Button--icon"),t.add(r,m("div",{className:"LogInButtonContainer LogInButtonContainer--".concat(r)},m(U(),{className:s,icon:i,path:"/auth/".concat(r),disabled:n().fof_oauth_loginInProgress},n().translator.trans("lstechneighbor-tcp-oidc.forum.log_in.with_".concat(r,"_button"),{provider:n().translator.trans("lstechneighbor-tcp-oidc.forum.providers.".concat(r))}))),a)}))})),(0,r.override)(U().prototype,"view",(function(t,o){if(!n().forum.attribute("lstechneighbor-tcp-oidc.only_icons"))return t(o);const e=t(o);return m(j(),{text:A()(e.children[1])},e)})),(0,r.extend)(M().prototype,"view",(function(t){n().forum.attribute("lstechneighbor-tcp-oidc.only_icons")&&(t.attrs.className+=" FoFLogInButtons--icons")})),(0,r.extend)("flarum/forum/ForumApplication","authenticationComplete",(function(t,o){o.loggedIn&&(n().fof_oauth_loginInProgress=!0,m.redraw())})),(0,r.override)("flarum/forum/ForumApplication","authenticationComplete",(async function(){try{n().fof_oauth_linkingInProgress=!0,m.redraw();const t=await this.store.find("linked-accounts"),o=this.store.all("linked-accounts").filter((t=>null===t.providerIdentifier())).find((o=>t.some((t=>t.name()===o.name()))));if(!o)return void window.location.reload();delete this.store.data["linked-accounts"][o.id()],await this.store.find("users",n().session.user.id()),n().fof_oauth_linkingInProgress=!1,m.redraw()}catch(t){n().fof_oauth_linkingInProgress=!1,m.redraw()}})),(0,r.extend)("flarum/forum/components/LogInModal","onbeforeupdate",(function(t){n().fof_oauth_loginInProgress&&(this.loading=!0)})),(0,r.extend)("flarum/forum/components/SignUpModal","onbeforeupdate",(function(t){n().fof_oauth_loginInProgress&&(this.loading=!0)})),(0,r.extend)("flarum/forum/components/SignUpModal","fields",(function(t){return this.attrs.token&&!this.attrs.username&&t.add("username-help",m("div",null,m("p",null,n().translator.trans("lstechneighbor-tcp-oidc.forum.signup.username_help"))),35),t})),O()}))})(),module.exports=o})();
//# sourceMappingURL=forum.js.map